{
  "hash": "935c403234c6aae598ce0b39c810f840",
  "result": {
    "markdown": "---\ntitle: \"Case Study: Concept of Confounders in Randomized Clinical Trials (RCTs) or A/B Testings\"\ndescription: \"A/B Testing and Confounders in TikTok Ads\"\nauthor:\n  - name: Sharon Voon\n    url: https://s-voon.github.io/\n    affiliation: Master of Data Science Student, UBC, 2023\ndate: 09-27-2024\ncategories: [Hypothesis Testing, A/B Testing]\ncitation: \n  url: https://s-voon.github.io/blogs/ads_hypothesis_testing/\nimage: preview.png\ndraft: false \n---\n\n\n<style>\nh1.title {\n    color: white;\n}\n</style>\n\n## Introduction\n\nUnderstanding confounders is critical when analyzing randomized versus non-randomized studies. In A/B testing or RCTs, we aim to minimize bias caused by confounders, which are variables that influence both the predictor and outcome, leading to distorted results.\n\nA confounder must meet two conditions:\n\na) It relates to the outcome of interest.\nb) Its distribution varies across groups being compared.\n\n## Case Study\nA TikTok ad experiment involves comparing engagement between a New Ad and the Current Ad by measuring ad dwell time. Assume the customer population is split across two cities: Vancouver and Victoria. Older customers and those in Victoria have naturally higher dwell times. Here, the variables age and city act as confounders.\n\nThe response variable is ad dwell time and the regressor is the ad type. The challenge is controlling for the confounders to properly estimate the effect of the new ad.\n\nKey Concepts:\n- Observational Studies: When customers choose which ad they want to see, biases arise, making it difficult to determine causal relationships.\n- Experimentation Studies: Through random assignment (Randomization), each customer has an equal chance of seeing either ad, reducing confounding and allowing for a causal interpretation.\n\n## Simulating a Synthetic Population\n \nWe'll generate a population of 1,000,000 customers, evenly split between Vancouver and Victoria. Ages are uniformly distributed between 16 and 24.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'ggplot2' was built under R version 4.3.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.3     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.4     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.0\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\n# Synthesizing sample population\npop.size <- 1000000\npop.pool <- tibble(\n  city = sample(c(rep(\"Vancouver\", pop.size/2), rep(\"Victoria\", pop.size/2))),\n  age = runif(pop.size, 16,24) # Random number generator form uniform distribution\n)\n```\n:::\n\n\nThe dwell times for each customer are calculated based on city and age. Victoria customers naturally have 5 more seconds dwell time, and for every additional year of age, dwell time increases by 0.2 seconds.\n\n- Current Ad: Baseline dwell time is 15 seconds, with adjustments for city and age.\n- New Ad: Adds 8 seconds to the dwell time across all customers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_current_ad <- 15 + 5 * (pop.pool$city == \"Victoria\") + 0.2 * pop.pool$age\nround(head(mean_current_ad), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 24.2644 24.0988 18.4521 23.6112 24.0925 24.0648\n```\n:::\n\n```{.r .cell-code}\nmean_new_ad <- mean_current_ad + 8\nround(head(mean_new_ad), 4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 32.2644 32.0988 26.4521 31.6112 32.0925 32.0648\n```\n:::\n\n```{.r .cell-code}\nset.seed(554) # Reproducibility\n\npop.pool$y_current_ad <- rnorm(pop.size, mean = mean_current_ad, sd = 1)\npop.pool$y_new_ad <- rnorm(pop.size, mean = mean_new_ad, sd = 1)\n```\n:::\n\n\nOnce we have these vectors of means, we can simulate the corresponding responses y_current_ad and y_new_ad and incorporate them in pop.pool as two new columns. These responses will be normally distributed (i.e., rnorm()) with means mean_current_ad and mean_new_ad and fixed standard deviations of 1 second.\n\n## Study 1: Naive Observational Approach\nIn this observational study, customers choose which ad to watch. The probability of selecting the New Ad increases for Victoria customers but decreases slightly with age.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npop.pool$x_self_choice <- as.factor(rbinom(pop.size, 1, prob = 0.5 + 0.5 * (pop.pool$city == \"Victoria\") - 0.005 * pop.pool$age))\n\npop.pool$x_self_choice <- fct_recode(pop.pool$x_self_choice, \"Current Ad\" = \"0\", \"New Ad\" = \"1\")\n```\n:::\n\n\nWe observe dwell times for 1,000 randomly sampled customers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(infer)\nsample_TikTok <- rep_sample_n(pop.pool, size = 1000)\n\nsample_TikTok$y_obs <- ifelse(sample_TikTok$x_self_choice == \"Current Ad\",\n  pop.pool$y_current_ad, pop.pool$y_new_ad)\n```\n:::\n\n\n### Exploratory Data Anakysis (EDA)\nThe violin plot below shows that customers who choose the New Ad tend to have higher dwell times. However, this difference might be due to confounding by age and city.\n![Violin plot for Obervation study of 1000 samples](EDA_obsv.png)\n\n### Regression Model\nUsing an OLS model, we estimate that effect of switching to the new ad as below:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(broom)\nOLS_naive_obs_study_TikTok <- lm(y_obs ~ x_self_choice, data = sample_TikTok)\n\nOLS_naive_obs_study_TikTok_results <- tidy(OLS_naive_obs_study_TikTok, conf.int = TRUE) %>% mutate_if(is.numeric, round, 2)\nOLS_naive_obs_study_TikTok_results\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 7\n  term                estimate std.error statistic p.value conf.low conf.high\n  <chr>                  <dbl>     <dbl>     <dbl>   <dbl>    <dbl>     <dbl>\n1 (Intercept)             21.6      0.14     150.        0    21.4      21.9 \n2 x_self_choiceNew Ad      8        0.18      44.6       0     7.65      8.36\n```\n:::\n:::\n\n![The result of the regression model](regresion_model_result_obsv.png)\n\nNote the estimated effect in dwell time, when switching from the current to the new ad, increases by 10.68 seconds and is statistically significant. The effect is clearly overestimated in this analysis, even when computing the 95% CI!\n\n## Study 2: Less Naive Observational Study\nBy controlling for city and age (causal covariates confounders), we improve the accuracy of our estimates. The dwell time increase due to the New Ad is now estimated at 8.03 seconds, which is much closer to the true effect.\n\n::: {.cell}\n\n```{.r .cell-code}\nOLS_obs_study_TikTok <- lm(y_obs ~ x_self_choice + city + age, data = sample_TikTok)\n\nOLS_obs_study_TikTok <- tidy(OLS_obs_study_TikTok, conf.int = TRUE) %>% mutate_if(is.numeric, round, 2)\nOLS_obs_study_TikTok\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 7\n  term                estimate std.error statistic p.value conf.low conf.high\n  <chr>                  <dbl>     <dbl>     <dbl>   <dbl>    <dbl>     <dbl>\n1 (Intercept)            20.4       0.77     26.6     0       18.9      22.0 \n2 x_self_choiceNew Ad     8.04      0.22     37.4     0        7.62      8.46\n3 cityVictoria           -0.04      0.21     -0.21    0.83    -0.45      0.36\n4 age                     0.06      0.04      1.6     0.11    -0.01      0.13\n```\n:::\n:::\n\n![The result of the regression model taking into account of city and age](regresion_model_result_obsv_2.png)\n\n## Study 3: Randomized Study\nIn the randomized study, customers are randomly assigned to view either the current or the new ad. This eliminates the effect of confounders and allows for an unbiased estimate of the ad's impact on dwell time.\n\n::: {.cell}\n\n```{.r .cell-code}\nsample_TikTok$x_randomized <- sample(c(\n  rep(\"Current Ad\", nrow(sample_TikTok) / 2),\n  rep(\"New Ad\", nrow(sample_TikTok) / 2)\n))\nsample_TikTok$y_exp <- ifelse(sample_TikTok$x_randomized == \"Current Ad\",\n  sample_TikTok$y_current_ad, sample_TikTok$y_new_ad\n)\n```\n:::\n\n\n### EDA\nBefore fitting the corresponding regression, let us compare the side-by-side boxplots of the naive observational study versus the experimental study. The violin plot below shows taht the treatment means are closer in the experimental study, and treatment data spread is graphically quite similar.\n![The violin plot of both less naive observational study and experimental study](EDA_obsv_2.png)\n\n### Regression Model\n\n::: {.cell}\n\n```{.r .cell-code}\nOLS_exp_study_TikTok <- lm(y_exp ~ x_randomized,\n  data = sample_TikTok\n)\n\nOLS_exp_study_TikTok_results <- tidy(OLS_exp_study_TikTok, conf.int = TRUE) %>% mutate_if(is.numeric, round, 2)\nOLS_exp_study_TikTok_results\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 7\n  term               estimate std.error statistic p.value conf.low conf.high\n  <chr>                 <dbl>     <dbl>     <dbl>   <dbl>    <dbl>     <dbl>\n1 (Intercept)           21.4       0.12     176.        0    21.2      21.7 \n2 x_randomizedNew Ad     7.89      0.17      45.8       0     7.55      8.23\n```\n:::\n:::\n\n![The result of the regression model for the randomizaton experimentation.](regresion_model_result_exp.png)\n\nNote the estimated experimental effect in dwell time, when switching from the current to the new ad, increases by 8.22 seconds and is statistically significant. According to the output above, we obtain more accurate estimations with a randomized study than a naive observational one.\n\nWhen taken into account of the city and age variable, the estimated effect from this randomized design is exactly 8 seconds, confirming the true effect of the new ad on dwell time.\n\n## Conclusion\nRandomization effectively eliminates confounding, allowing us to accurately estimate the causal effect of the New Ad. This case study demonstrates the importance of detecting and controlling for confounders in A/B testing and highlights the gold standard of randomized experiments in measuring causal effects.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}